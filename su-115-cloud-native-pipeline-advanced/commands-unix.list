###############################################
#Prepare your local environment
###############################################
#keep your git directory in memory for latest command
export SCRIPT_DIR=$(pwd)

#here we assume your etc host has been changed to have jfrog.local going to your artifactory instance.
#in order to validate this you can run (expected result : OK) :

curl http://jfrog.local/artifactory/api/system/ping 

#save your password

export ADMIN_PASSWORD=<password>


################################################
#init
################################################
#Remove uneeded repository from templated environment

#Create base needed repository fro gradle (gradle-dev-local, gradle-release-local, libs-release)
curl -uadmin:$ADMIN_PASSWORD -X PUT http://jfrog.local/artifactory/api/repositories/gradle-dev-local -H "content-type: application/vnd.org.jfrog.artifactory.repositories.LocalRepositoryConfiguration+json" -T $SCRIPT_DIR/init/repository-gradle-dev-local-config.json
curl -uadmin:$ADMIN_PASSWORD -X PUT http://jfrog.local/artifactory/api/repositories/gradle-release-local -H "content-type: application/vnd.org.jfrog.artifactory.repositories.LocalRepositoryConfiguration+json" -T $SCRIPT_DIR/init/repository-gradle-dev-local-config.json
curl -uadmin:$ADMIN_PASSWORD -X PUT http://jfrog.local/artifactory/api/repositories/jcenter -H "content-type: application/vnd.org.jfrog.artifactory.repositories.RemoteRepositoryConfiguration+json" -T $SCRIPT_DIR/init/jcenter-remote-config.json
curl -uadmin:$ADMIN_PASSWORD -X PUT http://jfrog.local/artifactory/api/repositories/libs-releases -H "content-type: application/vnd.org.jfrog.artifactory.repositories.VirtualRepositoryConfiguration+json" -T $SCRIPT_DIR/init/repository-gradle-release-virtual-config.json

#Create repositories for docker pipelines (prerequisites for lab1)
curl -uadmin:$ADMIN_PASSWORD -X PUT http://jfrog.local/artifactory/api/repositories/docker-dev-local -H "content-type: application/vnd.org.jfrog.artifactory.repositories.LocalRepositoryConfiguration+json" -T $SCRIPT_DIR/init/repository-docker-dev-local-config.json
curl -uadmin:$ADMIN_PASSWORD -X POST http://jfrog.local/artifactory/api/repositories/docker-virtual -H "content-type: application/vnd.org.jfrog.artifactory.repositories.VirtualRepositoryConfiguration+json" -T $SCRIPT_DIR/init/repository-docker-virtual-config.json

################################################
#Lab 2
################################################
#Create a docker-prod-local repository
curl -uadmin:$ADMIN_PASSWORD -X PUT http://jfrog.local/artifactory/api/repositories/docker-prod-local -H "content-type: application/vnd.org.jfrog.artifactory.repositories.LocalRepositoryConfiguration+json" -T $SCRIPT_DIR/init/repository-docker-dev-local-config.json

#update docker virtual repository
curl -uadmin:$ADMIN_PASSWORD -X POST http://jfrog.local/artifactory/api/repositories/docker-virtual -H "content-type: application/vnd.org.jfrog.artifactory.repositories.VirtualRepositoryConfiguration+json" -T $SCRIPT_DIR/lab2/repository-docker-virtual-config.json

################################################
#Lab 3
################################################
#Create a helm-local repository
curl -uadmin:$ADMIN_PASSWORD -X PUT http://jfrog.local/artifactory/api/repositories/helm-local -H "content-type: application/vnd.org.jfrog.artifactory.repositories.LocalRepositoryConfiguration+json" -T $SCRIPT_DIR/lab3/repository-helm-local-config.json

#update docker virtual repository
curl -uadmin:$ADMIN_PASSWORD -X PUT http://jfrog.local/artifactory/api/repositories/helm -H "content-type: application/vnd.org.jfrog.artifactory.repositories.VirtualRepositoryConfiguration+json" -T $SCRIPT_DIR/lab3/repository-helm-virtual-config.json

################################################
#Lab 5
################################################
#create a full mesh topology for docker repositories

#create same repo structure on each site

#create repo target for replication

#create virtual repositories


#configure Access Federation in mesh

################################################
#Lab 6
################################################
#Get service ids
export id_main=$(curl -uadmin:$ADMIN_PASSWORD -X POST  http://jfrog.local/artifactory/api/system/service_id)

sed -ie s#jfrt@...#$id_main#g $SCRIPT_DIR/lab6/release-bundle.json

#Create and sign a Release Bundle
curl -uadmin:$ADMIN_PASSWORD http://jfrog.local:PORTDISTRIB/api/v1/release_bundle -H "Content-Type: application/json" -T $SCRIPT_DIR/lab6/release-bundle.json

#Distribute the Release Bundle
curl -uadmin:$ADMIN_PASSWORD http://jfrog.local:PORTDISTRIB/api/v1/distribution/MySwampupProduct/1.0 -H "Content-Type: application/json" -T $SCRIPT_DIR/lab6/distribution.json





 